var wpWidgets;(function(a){wpWidgets={init:function(){var b,c=a("div.widgets-sortables"),d="undefined"!=typeof isRtl&&!!isRtl,e=isRtl?"marginRight":"marginLeft",f;a("#widgets-right").children(".widgets-holder-wrap").children(".sidebar-name").click(function(){var b=a(this).siblings(".widgets-sortables"),c=a(this).parent();if(!c.hasClass("closed")){b.sortable("disable");c.addClass("closed")}else{c.removeClass("closed");b.sortable("enable").sortable("refresh")}});a("#widgets-left").children(".widgets-holder-wrap").children(".sidebar-name").click(function(){a(this).parent().toggleClass("closed")});c.each(function(){if(a(this).parent().hasClass("inactive"))return!0;var b=50,c=a(this).children(".widget").length;b+=parseInt(c*48,10);a(this).css("minHeight",b+"px")});a("a.widget-action").live("click",function(){var b={},c=a(this).closest("div.widget"),d=c.children(".widget-inside"),f=parseInt(c.find("input.widget-width").val(),10);if(d.is(":hidden")){if(f>250&&d.closest("div.widgets-sortables").length){b.width=f+30+"px";d.closest("div.widget-liquid-right").length&&(b[e]=235-f+"px");c.css(b)}wpWidgets.fixLabels(c);d.slideDown("fast")}else d.slideUp("fast",function(){c.css({width:"",margin:""})});return!1});a("input.widget-control-save").live("click",function(){wpWidgets.save(a(this).closest("div.widget"),0,1,0);return!1});a("a.widget-control-remove").live("click",function(){wpWidgets.save(a(this).closest("div.widget"),1,1,0);return!1});a("a.widget-control-close").live("click",function(){wpWidgets.close(a(this).closest("div.widget"));return!1});c.children(".widget").each(function(){wpWidgets.appendTitle(this);a("p.widget-error",this).length&&a("a.widget-action",this).click()});a("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:5,containment:"document",start:function(a,b){b.helper.find("div.widget-description").hide();f=this.id},stop:function(c,d){b&&a(b).hide();b=""}});c.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"document",start:function(a,b){b.item.children(".widget-inside").hide();b.item.css({margin:"",width:""})},stop:function(c,d){d.item.hasClass("ui-draggable")&&d.item.data("draggable")&&d.item.draggable("destroy");if(d.item.hasClass("deleting")){wpWidgets.save(d.item,1,0,1);d.item.remove();return}var e=d.item.find("input.add_new").val(),g=d.item.find("input.multi_number").val(),h=f,i=a(this).attr("id");d.item.css({margin:"",width:""});f="";if(e){if("multi"==e){d.item.html(d.item.html().replace(/<[^<>]+>/g,function(a){return a.replace(/__i__|%i%/g,g)}));d.item.attr("id",h.replace("__i__",g));g++;a("div#"+h).find("input.multi_number").val(g)}else if("single"==e){d.item.attr("id","new-"+h);b="div#"+h}wpWidgets.save(d.item,0,0,1);d.item.find("input.add_new").val("");d.item.find("a.widget-action").click();return}wpWidgets.saveOrder(i)},receive:function(b,c){var d=a(c.sender);(!a(this).is(":visible")||this.id.indexOf("orphaned_widgets")!=-1)&&d.sortable("cancel");d.attr("id").indexOf("orphaned_widgets")!=-1&&!d.children(".widget").length&&d.parents(".orphan-sidebar").slideUp(400,function(){a(this).remove()})}}).sortable("option","connectWith","div.widgets-sortables").parent().filter(".closed").children(".widgets-sortables").sortable("disable");a("#available-widgets").droppable({tolerance:"pointer",accept:function(b){return a(b).parent().attr("id")!="widget-list"},drop:function(b,c){c.draggable.addClass("deleting");a("#removing-widget").hide().children("span").html("")},over:function(b,c){c.draggable.addClass("deleting");a("div.widget-placeholder").hide();c.draggable.hasClass("ui-sortable-helper")&&a("#removing-widget").show().children("span").html(c.draggable.find("div.widget-title").children("h4").html())},out:function(b,c){c.draggable.removeClass("deleting");a("div.widget-placeholder").show();a("#removing-widget").hide().children("span").html("")}})},saveOrder:function(b){b&&a("#"+b).closest("div.widgets-holder-wrap").find("img.ajax-feedback").css("visibility","visible");var c={action:"widgets-order",savewidgets:a("#_wpnonce_widgets").val(),sidebars:[]};a("div.widgets-sortables").each(function(){a(this).sortable&&(c["sidebars["+a(this).attr("id")+"]"]=a(this).sortable("toArray").join(","))});a.post(ajaxurl,c,function(){a("img.ajax-feedback").css("visibility","hidden")});this.resize()},save:function(b,c,d,e){var f=b.closest("div.widgets-sortables").attr("id"),g=b.find("form").serialize(),h;b=a(b);a(".ajax-feedback",b).css("visibility","visible");h={action:"save-widget",savewidgets:a("#_wpnonce_widgets").val(),sidebar:f};c&&(h.delete_widget=1);g+="&"+a.param(h);a.post(ajaxurl,g,function(f){var g;if(c){if(!a("input.widget_number",b).val()){g=a("input.widget-id",b).val();a("#available-widgets").find("input.widget-id").each(function(){a(this).val()==g&&a(this).closest("div.widget").show()})}if(d){e=0;b.slideUp("fast",function(){a(this).remove();wpWidgets.saveOrder()})}else{b.remove();wpWidgets.resize()}}else{a(".ajax-feedback").css("visibility","hidden");if(f&&f.length>2){a("div.widget-content",b).html(f);wpWidgets.appendTitle(b);wpWidgets.fixLabels(b)}}e&&wpWidgets.saveOrder()})},appendTitle:function(b){var c=a('input[id*="-title"]',b).val()||"";c&&(c=": "+c.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;"));a(b).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(c)},resize:function(){a("div.widgets-sortables").each(function(){if(a(this).parent().hasClass("inactive"))return!0;var b=50,c=a(this).children(".widget").length;b+=parseInt(c*48,10);a(this).css("minHeight",b+"px")})},fixLabels:function(b){b.children(".widget-inside").find("label").each(function(){var b=a(this).attr("for");b&&b==a("input",this).attr("id")&&a(this).removeAttr("for")})},close:function(a){a.children(".widget-inside").slideUp("fast",function(){a.css({width:"",margin:""})})}};a(document).ready(function(a){wpWidgets.init()})})(jQuery);