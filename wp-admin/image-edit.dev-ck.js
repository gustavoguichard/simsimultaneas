var imageEdit;(function(a){imageEdit={iasapi:{},hold:{},postid:"",intval:function(a){return a|0},setDisabled:function(b,c){if(c){b.removeClass("disabled");a("input",b).removeAttr("disabled")}else{b.addClass("disabled");a("input",b).prop("disabled",!0)}},init:function(b,c){var d=this,e=a("#image-editor-"+d.postid),f=d.intval(a("#imgedit-x-"+b).val()),g=d.intval(a("#imgedit-y-"+b).val());d.postid!=b&&e.length&&d.close(d.postid);d.hold.w=d.hold.ow=f;d.hold.h=d.hold.oh=g;d.hold.xy_ratio=f/g;d.hold.sizer=parseFloat(a("#imgedit-sizer-"+b).val());d.postid=b;a("#imgedit-response-"+b).empty();a('input[type="text"]',"#imgedit-panel-"+b).keypress(function(b){var c=b.keyCode;36<c&&c<41&&a(this).blur();if(13==c){b.preventDefault();b.stopPropagation();return!1}})},toggleEditor:function(b,c){var d=a("#imgedit-wait-"+b);c?d.height(a("#imgedit-panel-"+b).height()).fadeIn("fast"):d.fadeOut("fast")},toggleHelp:function(b){a(b).siblings(".imgedit-help").slideToggle("fast");return!1},getTarget:function(b){return a('input[name="imgedit-target-'+b+'"]:checked',"#imgedit-save-target-"+b).val()||"full"},scaleChanged:function(b,c){var d=a("#imgedit-scale-width-"+b),e=a("#imgedit-scale-height-"+b),f=a("#imgedit-scale-warn-"+b),g="",h="";if(c){h=d.val()!=""?this.intval(d.val()/this.hold.xy_ratio):"";e.val(h)}else{g=e.val()!=""?this.intval(e.val()*this.hold.xy_ratio):"";d.val(g)}h&&h>this.hold.oh||g&&g>this.hold.ow?f.css("visibility","visible"):f.css("visibility","hidden")},getSelRatio:function(b){var c=this.hold.w,d=this.hold.h,e=this.intval(a("#imgedit-crop-width-"+b).val()),f=this.intval(a("#imgedit-crop-height-"+b).val());return e&&f?e+":"+f:c&&d?c+":"+d:"1:1"},filterHistory:function(b,c){var d=a("#imgedit-history-"+b).val(),e,f,g,h,i=[];if(d!=""){d=JSON.parse(d);e=this.intval(a("#imgedit-undone-"+b).val());if(e>0)while(e>0){d.pop();e--}if(c){if(!d.length){this.hold.w=this.hold.ow;this.hold.h=this.hold.oh;return""}g=d[d.length-1];g=g.c||g.r||g.f||!1;if(g){this.hold.w=g.fw;this.hold.h=g.fh}}for(f in d){h=d[f];h.hasOwnProperty("c")?i[f]={c:{x:h.c.x,y:h.c.y,w:h.c.w,h:h.c.h}}:h.hasOwnProperty("r")?i[f]={r:h.r.r}:h.hasOwnProperty("f")&&(i[f]={f:h.f.f})}return JSON.stringify(i)}return""},refreshEditor:function(b,c,d){var e=this,f,g;e.toggleEditor(b,1);f={action:"imgedit-preview",_ajax_nonce:c,postid:b,history:e.filterHistory(b,1),rand:e.intval(Math.random()*1e6)};g=a('<img id="image-preview-'+b+'" />');g.load(function(){var c,e,f=a("#imgedit-crop-"+b),h=imageEdit;f.empty().append(g);c=Math.max(h.hold.w,h.hold.h);e=Math.max(a(g).width(),a(g).height());h.hold.sizer=c>e?e/c:1;h.initCrop(b,g,f);h.setCropSelection(b,0);typeof d!="unknown"&&d!=null&&d();a("#imgedit-history-"+b).val()&&a("#imgedit-undone-"+b).val()==0?a("input.imgedit-submit-btn","#imgedit-panel-"+b).removeAttr("disabled"):a("input.imgedit-submit-btn","#imgedit-panel-"+b).prop("disabled",!0);h.toggleEditor(b,0)}).error(function(){a("#imgedit-crop-"+b).empty().append('<div class="error"><p>'+imageEditL10n.error+"</p></div>");e.toggleEditor(b,0)}).attr("src",ajaxurl+"?"+a.param(f))},action:function(b,c,d){var e=this,f,g,h,i,j;if(e.notsaved(b))return!1;f={action:"image-editor",_ajax_nonce:c,postid:b};if("scale"==d){g=a("#imgedit-scale-width-"+b),h=a("#imgedit-scale-height-"+b),i=e.intval(g.val()),j=e.intval(h.val());if(i<1){g.focus();return!1}if(j<1){h.focus();return!1}if(i==e.hold.ow||j==e.hold.oh)return!1;f["do"]="scale";f.fwidth=i;f.fheight=j}else{if("restore"!=d)return!1;f["do"]="restore"}e.toggleEditor(b,1);a.post(ajaxurl,f,function(c){a("#image-editor-"+b).empty().append(c);e.toggleEditor(b,0)})},save:function(b,c){var d,e=this.getTarget(b),f=this.filterHistory(b,0);if(""==f)return!1;this.toggleEditor(b,1);d={action:"image-editor",_ajax_nonce:c,postid:b,history:f,target:e,"do":"save"};a.post(ajaxurl,d,function(c){var d=JSON.parse(c);if(d.error){a("#imgedit-response-"+b).html('<div class="error"><p>'+d.error+"</p><div>");imageEdit.close(b);return}d.fw&&d.fh&&a("#media-dims-"+b).html(d.fw+" &times; "+d.fh);d.thumbnail&&a(".thumbnail","#thumbnail-head-"+b).attr("src",""+d.thumbnail);d.msg&&a("#imgedit-response-"+b).html('<div class="updated"><p>'+d.msg+"</p></div>");imageEdit.close(b)})},open:function(b,c){var d,e=a("#image-editor-"+b),f=a("#media-head-"+b),g=a("#imgedit-open-btn-"+b),h=g.siblings("img");g.prop("disabled",!0);h.css("visibility","visible");d={action:"image-editor",_ajax_nonce:c,postid:b,"do":"open"};e.load(ajaxurl,d,function(){e.fadeIn("fast");f.fadeOut("fast",function(){g.removeAttr("disabled");h.css("visibility","hidden")})})},imgLoaded:function(b){var c=a("#image-preview-"+b),d=a("#imgedit-crop-"+b);this.initCrop(b,c,d);this.setCropSelection(b,0);this.toggleEditor(b,0)},initCrop:function(b,c,d){var e=this,f=a("#imgedit-sel-width-"+b),g=a("#imgedit-sel-height-"+b);e.iasapi=a(c).imgAreaSelect({parent:d,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,onInit:function(a,c){d.children().mousedown(function(a){var c=!1,d,f;if(a.shiftKey){d=e.iasapi.getSelection();f=e.getSelRatio(b);c=d&&d.width&&d.height?d.width+":"+d.height:f}e.iasapi.setOptions({aspectRatio:c})})},onSelectStart:function(c,d){imageEdit.setDisabled(a("#imgedit-crop-sel-"+b),1)},onSelectEnd:function(a,c){imageEdit.setCropSelection(b,c)},onSelectChange:function(a,b){var c=imageEdit.hold.sizer;f.val(imageEdit.round(b.width/c));g.val(imageEdit.round(b.height/c))}})},setCropSelection:function(b,c){var d,e=a("#imgedit-minthumb-"+b).val()||"128:128",f=this.hold.sizer;e=e.split(":");c=c||0;if(!c||c.width<3&&c.height<3){this.setDisabled(a(".imgedit-crop","#imgedit-panel-"+b),0);this.setDisabled(a("#imgedit-crop-sel-"+b),0);a("#imgedit-sel-width-"+b).val("");a("#imgedit-sel-height-"+b).val("");a("#imgedit-selection-"+b).val("");return!1}if(c.width<e[0]*f&&c.height<e[1]*f){this.setDisabled(a(".imgedit-crop","#imgedit-panel-"+b),0);a("#imgedit-selection-"+b).val("");return!1}d={x:c.x1,y:c.y1,w:c.width,h:c.height};this.setDisabled(a(".imgedit-crop","#imgedit-panel-"+b),1);a("#imgedit-selection-"+b).val(JSON.stringify(d))},close:function(b,c){c=c||!1;if(c&&this.notsaved(b))return!1;this.iasapi={};this.hold={};a("#image-editor-"+b).fadeOut("fast",function(){a("#media-head-"+b).fadeIn("fast");a(this).empty()})},notsaved:function(b){var c=a("#imgedit-history-"+b).val(),d=c!=""?JSON.parse(c):new Array,e=this.intval(a("#imgedit-undone-"+b).val());return e<d.length?confirm(a("#imgedit-leaving-"+b).html())?!1:!0:!1},addStep:function(b,c,d){var e=this,f=a("#imgedit-history-"+c),g=f.val()!=""?JSON.parse(f.val()):new Array,h=a("#imgedit-undone-"+c),i=e.intval(h.val());while(i>0){g.pop();i--}h.val(0);g.push(b);f.val(JSON.stringify(g));e.refreshEditor(c,d,function(){e.setDisabled(a("#image-undo-"+c),!0);e.setDisabled(a("#image-redo-"+c),!1)})},rotate:function(b,c,d,e){if(a(e).hasClass("disabled"))return!1;this.addStep({r:{r:b,fw:this.hold.h,fh:this.hold.w}},c,d)},flip:function(b,c,d,e){if(a(e).hasClass("disabled"))return!1;this.addStep({f:{f:b,fw:this.hold.w,fh:this.hold.h}},c,d)},crop:function(b,c,d){var e=a("#imgedit-selection-"+b).val(),f=this.intval(a("#imgedit-sel-width-"+b).val()),g=this.intval(a("#imgedit-sel-height-"+b).val());if(a(d).hasClass("disabled")||e=="")return!1;e=JSON.parse(e);if(e.w>0&&e.h>0&&f>0&&g>0){e.fw=f;e.fh=g;this.addStep({c:e},b,c)}},undo:function(b,c){var d=this,e=a("#image-undo-"+b),f=a("#imgedit-undone-"+b),g=d.intval(f.val())+1;if(e.hasClass("disabled"))return;f.val(g);d.refreshEditor(b,c,function(){var c=a("#imgedit-history-"+b),f=c.val()!=""?JSON.parse(c.val()):new Array;d.setDisabled(a("#image-redo-"+b),!0);d.setDisabled(e,g<f.length)})},redo:function(b,c){var d=this,e=a("#image-redo-"+b),f=a("#imgedit-undone-"+b),g=d.intval(f.val())-1;if(e.hasClass("disabled"))return;f.val(g);d.refreshEditor(b,c,function(){d.setDisabled(a("#image-undo-"+b),!0);d.setDisabled(e,g>0)})},setNumSelection:function(b){var c,d=a("#imgedit-sel-width-"+b),e=a("#imgedit-sel-height-"+b),f=this.intval(d.val()),g=this.intval(e.val()),h=a("#image-preview-"+b),i=h.height(),j=h.width(),k=this.hold.sizer,l,m,n,o,p=this.iasapi;if(f<1){d.val("");return!1}if(g<1){e.val("");return!1}if(f&&g&&(c=p.getSelection())){n=c.x1+Math.round(f*k);o=c.y1+Math.round(g*k);l=c.x1;m=c.y1;if(n>j){l=0;n=j;d.val(Math.round(n/k))}if(o>i){m=0;o=i;e.val(Math.round(o/k))}p.setSelection(l,m,n,o);p.update();this.setCropSelection(b,p.getSelection())}},round:function(a){var b;a=Math.round(a);if(this.hold.sizer>.6)return a;b=a.toString().slice(-1);return"1"==b?a-1:"9"==b?a+1:a},setRatioSelection:function(b,c,d){var e,f,g=this.intval(a("#imgedit-crop-width-"+b).val()),h=this.intval(a("#imgedit-crop-height-"+b).val()),i=a("#image-preview-"+b).height();if(!this.intval(a(d).val())){a(d).val("");return}if(g&&h){this.iasapi.setOptions({aspectRatio:g+":"+h});if(e=this.iasapi.getSelection(!0)){f=Math.ceil(e.y1+(e.x2-e.x1)/(g/h));if(f>i){f=i;c?a("#imgedit-crop-height-"+b).val(""):a("#imgedit-crop-width-"+b).val("")}this.iasapi.setSelection(e.x1,e.y1,e.x2,f);this.iasapi.update()}}}}})(jQuery);