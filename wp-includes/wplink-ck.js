var wpLink;(function(a){var b={},c={},d,e,f;wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",init:function(){b.dialog=a("#wp-link");b.submit=a("#wp-link-submit");b.url=a("#url-field");b.nonce=a("#_ajax_linking_nonce");b.title=a("#link-title-field");b.openInNewTab=a("#link-target-checkbox");b.search=a("#search-field");c.search=new e(a("#search-results"));c.recent=new e(a("#most-recent-results"));c.elements=a(".query-results",b.dialog);b.dialog.keydown(wpLink.keydown);b.dialog.keyup(wpLink.keyup);b.submit.click(function(a){a.preventDefault();wpLink.update()});a("#wp-link-cancel").click(function(a){a.preventDefault();wpLink.close()});a("#internal-toggle").click(wpLink.toggleInternalLinking);c.elements.bind("river-select",wpLink.updateFields);b.search.keyup(wpLink.searchInternalLinks);b.dialog.bind("wpdialogrefresh",wpLink.refresh);b.dialog.bind("wpdialogbeforeopen",wpLink.beforeOpen);b.dialog.bind("wpdialogclose",wpLink.onClose)},beforeOpen:function(){wpLink.range=null;if(!wpLink.isMCE()&&document.selection){wpLink.textarea.focus();wpLink.range=document.selection.createRange()}},open:function(){if(!wpActiveEditor)return;this.textarea=a("#"+wpActiveEditor).get(0);b.dialog.data("wpdialog")||b.dialog.wpdialog({title:wpLinkL10n.title,width:480,height:"auto",modal:!0,dialogClass:"wp-dialog",zIndex:3e5});b.dialog.wpdialog("open")},isMCE:function(){return tinyMCEPopup&&(d=tinyMCEPopup.editor)&&!d.isHidden()},refresh:function(){c.search.refresh();c.recent.refresh();wpLink.isMCE()?wpLink.mceRefresh():wpLink.setDefaultValues();b.url.focus()[0].select();c.recent.ul.children().length||c.recent.ajax()},mceRefresh:function(){var a;d=tinyMCEPopup.editor;tinyMCEPopup.restoreSelection();if(a=d.dom.getParent(d.selection.getNode(),"A")){b.url.val(d.dom.getAttrib(a,"href"));b.title.val(d.dom.getAttrib(a,"title"));"_blank"==d.dom.getAttrib(a,"target")&&b.openInNewTab.prop("checked",!0);b.submit.val(wpLinkL10n.update)}else wpLink.setDefaultValues();tinyMCEPopup.storeSelection()},close:function(){wpLink.isMCE()?tinyMCEPopup.close():b.dialog.wpdialog("close")},onClose:function(){if(!wpLink.isMCE()){wpLink.textarea.focus();if(wpLink.range){wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select()}}},getAttrs:function(){return{href:b.url.val(),title:b.title.val(),target:b.openInNewTab.prop("checked")?"_blank":""}},update:function(){wpLink.isMCE()?wpLink.mceUpdate():wpLink.htmlUpdate()},htmlUpdate:function(){var a,b,c,d,e,f=wpLink.textarea;if(!f)return;a=wpLink.getAttrs();if(!a.href||a.href=="http://")return;b='<a href="'+a.href+'"';a.title&&(b+=' title="'+a.title+'"');a.target&&(b+=' target="'+a.target+'"');b+=">";if(document.selection&&wpLink.range){f.focus();wpLink.range.text=b+wpLink.range.text+"</a>";wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select();wpLink.range=null}else if(typeof f.selectionStart!="undefined"){c=f.selectionStart;d=f.selectionEnd;selection=f.value.substring(c,d);b=b+selection+"</a>";e=c+b.length;c==d&&(e-="</a>".length);f.value=f.value.substring(0,c)+b+f.value.substring(d,f.value.length);f.selectionStart=f.selectionEnd=e}wpLink.close();f.focus()},mceUpdate:function(){var b=tinyMCEPopup.editor,c=wpLink.getAttrs(),d,e;tinyMCEPopup.restoreSelection();d=b.dom.getParent(b.selection.getNode(),"A");if(!c.href||c.href=="http://"){if(d){tinyMCEPopup.execCommand("mceBeginUndoLevel");e=b.selection.getBookmark();b.dom.remove(d,1);b.selection.moveToBookmark(e);tinyMCEPopup.execCommand("mceEndUndoLevel");wpLink.close()}return}tinyMCEPopup.execCommand("mceBeginUndoLevel");if(d==null){b.getDoc().execCommand("unlink",!1,null);tinyMCEPopup.execCommand("mceInsertLink",!1,"#mce_temp_url#",{skip_undo:1});tinymce.each(b.dom.select("a"),function(a){if(b.dom.getAttrib(a,"href")=="#mce_temp_url#"){d=a;b.dom.setAttribs(d,c)}});if(a(d).text()=="#mce_temp_url#"){b.dom.remove(d);d=null}}else b.dom.setAttribs(d,c);if(d&&(d.childNodes.length!=1||d.firstChild.nodeName!="IMG")){b.focus();b.selection.select(d);b.selection.collapse(0);tinyMCEPopup.storeSelection()}tinyMCEPopup.execCommand("mceEndUndoLevel");wpLink.close()},updateFields:function(a,c,d){b.url.val(c.children(".item-permalink").val());b.title.val(c.hasClass("no-title")?"":c.children(".item-title").text());d&&d.type=="click"&&b.url.focus()},setDefaultValues:function(){b.url.val("http://");b.title.val("");b.submit.val(wpLinkL10n.save)},searchInternalLinks:function(){var b=a(this),d,e=b.val();if(e.length>2){c.recent.hide();c.search.show();if(wpLink.lastSearch==e)return;wpLink.lastSearch=e;d=b.siblings("img.waiting").show();c.search.change(e);c.search.ajax(function(){d.hide()})}else{c.search.hide();c.recent.show()}},next:function(){c.search.next();c.recent.next()},prev:function(){c.search.prev();c.recent.prev()},keydown:function(b){var c,d=a.ui.keyCode;switch(b.which){case d.UP:c="prev";case d.DOWN:c=c||"next";clearInterval(wpLink.keyInterval);wpLink[c]();wpLink.keyInterval=setInterval(wpLink[c],wpLink.keySensitivity);break;default:return}b.preventDefault()},keyup:function(b){var c=a.ui.keyCode;switch(b.which){case c.ESCAPE:b.stopImmediatePropagation();a(document).triggerHandler("wp_CloseOnEscape",[{event:b,what:"wplink",cb:wpLink.close}])||wpLink.close();return!1;case c.UP:case c.DOWN:clearInterval(wpLink.keyInterval);break;default:return}b.preventDefault()},delayedCallback:function(a,b){var c,d,e,f;if(!b)return a;setTimeout(function(){if(d)return a.apply(f,e);c=!0},b);return function(){if(c)return a.apply(this,arguments);e=arguments;f=this;d=!0}},toggleInternalLinking:function(c){var d=a("#search-panel"),e=b.dialog.wpdialog("widget"),f=!d.is(":visible"),g=a(window);a(this).toggleClass("toggle-arrow-active",f);b.dialog.height("auto");d.slideToggle(300,function(){setUserSetting("wplink",f?"1":"0");b[f?"search":"url"].focus();var a=g.scrollTop(),c=e.offset().top,d=c+e.outerHeight(),h=d-g.height();h>a&&e.animate({top:h<c?c-h:a},200)});c.preventDefault()}};e=function(b,c){var d=this;this.element=b;this.ul=b.children("ul");this.waiting=b.find(".river-waiting");this.change(c);this.refresh();b.scroll(function(){d.maybeLoad()});b.delegate("li","click",function(b){d.select(a(this),b)})};a.extend(e.prototype,{refresh:function(){this.deselect();this.visible=this.element.is(":visible")},show:function(){if(!this.visible){this.deselect();this.element.show();this.visible=!0}},hide:function(){this.element.hide();this.visible=!1},select:function(a,b){var c,d,e,f;if(a.hasClass("unselectable")||a==this.selected)return;this.deselect();this.selected=a.addClass("selected");c=a.outerHeight();d=this.element.height();e=a.position().top;f=this.element.scrollTop();e<0?this.element.scrollTop(f+e):e+c>d&&this.element.scrollTop(f+e-d+c);this.element.trigger("river-select",[a,b,this])},deselect:function(){this.selected&&this.selected.removeClass("selected");this.selected=!1},prev:function(){if(!this.visible)return;var a;if(this.selected){a=this.selected.prev("li");a.length&&this.select(a)}},next:function(){if(!this.visible)return;var b=this.selected?this.selected.next("li"):a("li:not(.unselectable):first",this.element);b.length&&this.select(b)},ajax:function(a){var b=this,c=this.query.page==1?0:wpLink.minRiverAJAXDuration,d=wpLink.delayedCallback(function(c,d){b.process(c,d);a&&a(c,d)},c);this.query.ajax(d)},change:function(a){if(this.query&&this._search==a)return;this._search=a;this.query=new f(a);this.element.scrollTop(0)},process:function(b,c){var d="",e=!0,f="",g=c.page==1;b?a.each(b,function(){f=e?"alternate":"";f+=this.title?"":" no-title";d+=f?'<li class="'+f+'">':"<li>";d+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />';d+='<span class="item-title">';d+=this.title?this.title:wpLinkL10n.noTitle;d+='</span><span class="item-info">'+this.info+"</span></li>";e=!e}):g&&(d+='<li class="unselectable"><span class="item-title"><em>'+wpLinkL10n.noMatchesFound+"</em></span></li>");this.ul[g?"html":"append"](d)},maybeLoad:function(){var a=this,b=this.element,c=b.scrollTop()+b.height();if(!this.query.ready()||c<this.ul.height()-wpLink.riverBottomThreshold)return;setTimeout(function(){var c=b.scrollTop(),d=c+b.height();if(!a.query.ready()||d<a.ul.height()-wpLink.riverBottomThreshold)return;a.waiting.show();b.scrollTop(c+a.waiting.outerHeight());a.ajax(function(){a.waiting.hide()})},wpLink.timeToTriggerRiver)}});f=function(a){this.page=1;this.allLoaded=!1;this.querying=!1;this.search=a};a.extend(f.prototype,{ready:function(){return!this.querying&&!this.allLoaded},ajax:function(c){var d=this,e={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:b.nonce.val()};this.search&&(e.search=this.search);this.querying=!0;a.post(ajaxurl,e,function(a){d.page++;d.querying=!1;d.allLoaded=!a;c(a,e)},"json")}});a(document).ready(wpLink.init)})(jQuery);