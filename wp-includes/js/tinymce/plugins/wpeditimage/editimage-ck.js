var tinymce=null,tinyMCEPopup,tinyMCE,wpImage;tinyMCEPopup={init:function(){var a=this,b,c;b=a.getWin();tinymce=b.tinymce;tinyMCE=b.tinyMCE;a.editor=tinymce.EditorManager.activeEditor;a.params=a.editor.windowManager.params;a.features=a.editor.windowManager.features;a.dom=a.editor.windowManager.createInstance("tinymce.dom.DOMUtils",document);a.editor.windowManager.onOpen.dispatch(a.editor.windowManager,window)},getWin:function(){return!window.frameElement&&window.dialogArguments||opener||parent||top},getParam:function(a,b){return this.editor.getParam(a,b)},close:function(){function b(){a.editor.windowManager.close(window);tinymce=tinyMCE=a.editor=a.params=a.dom=a.dom.doc=null}var a=this;tinymce.isOpera?a.getWin().setTimeout(b,0):b()},execCommand:function(a,b,c,d){d=d||{};d.skip_focus=1;this.restoreSelection();return this.editor.execCommand(a,b,c,d)},storeSelection:function(){this.editor.windowManager.bookmark=tinyMCEPopup.editor.selection.getBookmark(1)},restoreSelection:function(){var a=tinyMCEPopup;tinymce.isIE&&a.editor.selection.moveToBookmark(a.editor.windowManager.bookmark)}};tinyMCEPopup.init();wpImage={preInit:function(){var a=tinyMCEPopup.editor,b=tinyMCEPopup.getWin(),c=b.document.styleSheets,d,e;for(e=0;e<c.length;e++){d=c.item(e).href;if(d&&d.indexOf("colors")!=-1){document.getElementsByTagName("head")[0].appendChild(a.dom.create("link",{rel:"stylesheet",href:d}));break}}},I:function(a){return document.getElementById(a)},current:"",link:"",link_rel:"",target_value:"",current_size_sel:"s100",width:"",height:"",align:"",img_alt:"",setTabs:function(a){var b=this;if("current"==a.className)return!1;b.I("div_advanced").style.display="tab_advanced"==a.id?"block":"none";b.I("div_basic").style.display="tab_basic"==a.id?"block":"none";b.I("tab_basic").className=b.I("tab_advanced").className="";a.className="current";return!1},img_seturl:function(a){var b=this,c=b.I("link_rel").value;if("current"==a){b.I("link_href").value=b.current;b.I("link_rel").value=b.link_rel}else{b.I("link_href").value=b.link;if(c){c=c.replace(/attachment|wp-att-[0-9]+/gi,"");b.I("link_rel").value=tinymce.trim(c)}}},imgAlignCls:function(a){var b=this,c=b.I("img_classes").value;b.I("img_demo").className=b.align=a;c=c.replace(/align[^ "']+/gi,"");c+=" "+a;c=c.replace(/\s+/g," ").replace(/^\s/,"");if("aligncenter"==a){b.I("hspace").value="";b.updateStyle("hspace")}b.I("img_classes").value=c},showSize:function(a){var b=this,c=b.I("img_demo"),d=b.width,e=b.height,f=a.id||"s100",g;g=parseInt(f.substring(1))/200;c.width=Math.round(d*g);c.height=Math.round(e*g);b.showSizeClear();a.style.borderColor="#A3A3A3";a.style.backgroundColor="#E5E5E5"},showSizeSet:function(){var a=this,b,c,d;if(a.width*1.3>parseInt(a.preloadImg.width)){b=a.I("s130"),c=a.I("s120"),d=a.I("s110");b.onclick=c.onclick=d.onclick=null;b.onmouseover=c.onmouseover=d.onmouseover=null;b.style.color=c.style.color=d.style.color="#aaa"}},showSizeRem:function(){var a=this,b=a.I("img_demo"),c=document.forms[0];b.width=Math.round(c.width.value*.5);b.height=Math.round(c.height.value*.5);a.showSizeClear();a.I(a.current_size_sel).style.borderColor="#A3A3A3";a.I(a.current_size_sel).style.backgroundColor="#E5E5E5";return!1},showSizeClear:function(){var a=this.I("img_size").getElementsByTagName("div"),b;for(b=0;b<a.length;b++){a[b].style.borderColor="#f1f1f1";a[b].style.backgroundColor="#f1f1f1"}},imgEditSize:function(a){var b=this,c=document.forms[0],d,e,f,g,h;if(!b.preloadImg||!b.preloadImg.width||!b.preloadImg.height)return;d=parseInt(b.preloadImg.width),e=parseInt(b.preloadImg.height),f=b.width||d,g=b.height||e,h=a.id||"s100";size=parseInt(h.substring(1))/100;f=Math.round(f*size);g=Math.round(g*size);c.width.value=Math.min(d,f);c.height.value=Math.min(e,g);b.current_size_sel=h;b.demoSetSize()},demoSetSize:function(a){var b=this.I("img_demo"),c=document.forms[0];b.width=c.width.value?Math.round(c.width.value*.5):"";b.height=c.height.value?Math.round(c.height.value*.5):""},demoSetStyle:function(){var a=document.forms[0],b=this.I("img_demo"),c=tinyMCEPopup.editor.dom;if(b){c.setAttrib(b,"style",a.img_style.value);c.setStyle(b,"width","");c.setStyle(b,"height","")}},origSize:function(){var a=this,b=document.forms[0],c=a.I("s100");b.width.value=a.width=a.preloadImg.width;b.height.value=a.height=a.preloadImg.height;a.showSizeSet();a.demoSetSize();a.showSize(c)},init:function(){var a=tinyMCEPopup.editor,b;b=document.body.innerHTML;document.body.innerHTML=a.translate(b);window.setTimeout(function(){wpImage.setup()},500)},setup:function(){var a=this,b,c,d,e,f=document.forms[0],g=tinyMCEPopup.editor,h=a.I("img_demo"),i=tinyMCEPopup.dom,j,k,l="",m,n;document.dir=tinyMCEPopup.editor.getParam("directionality","");tinyMCEPopup.editor.getParam("wpeditimage_disable_captions",!1)&&(a.I("cap_field").style.display="none");tinyMCEPopup.restoreSelection();c=g.selection.getNode();if(c.nodeName!="IMG")return;f.img_src.value=h.src=d=g.dom.getAttrib(c,"src");g.dom.setStyle(c,"float","");a.getImageData();b=g.dom.getAttrib(c,"class");if(j=i.getParent(c,"dl")){m=g.dom.getAttrib(j,"class");m=m.match(/align[^ "']+/i);if(m&&!i.hasClass(c,m)){b+=" "+m;tinymce.trim(b)}k=g.dom.select("dd.wp-caption-dd",j);k&&k[0]&&(l=g.serializer.serialize(k[0]).replace(/^<p>/,"").replace(/<\/p>$/,""))}f.img_cap_text.value=l;f.img_title.value=g.dom.getAttrib(c,"title");f.img_alt.value=g.dom.getAttrib(c,"alt");f.border.value=g.dom.getAttrib(c,"border");f.vspace.value=g.dom.getAttrib(c,"vspace");f.hspace.value=g.dom.getAttrib(c,"hspace");f.align.value=g.dom.getAttrib(c,"align");f.width.value=a.width=g.dom.getAttrib(c,"width");f.height.value=a.height=g.dom.getAttrib(c,"height");f.img_classes.value=b;f.img_style.value=g.dom.getAttrib(c,"style");i.getAttrib(c,"hspace")&&a.updateStyle("hspace");i.getAttrib(c,"border")&&a.updateStyle("border");i.getAttrib(c,"vspace")&&a.updateStyle("vspace");if(n=g.dom.getParent(c,"A")){f.link_href.value=a.current=g.dom.getAttrib(n,"href");f.link_title.value=g.dom.getAttrib(n,"title");f.link_rel.value=a.link_rel=g.dom.getAttrib(n,"rel");f.link_style.value=g.dom.getAttrib(n,"style");a.target_value=g.dom.getAttrib(n,"target");f.link_classes.value=g.dom.getAttrib(n,"class")}f.link_target.checked=a.target_value&&a.target_value=="_blank"?"checked":"";e=d.substring(d.lastIndexOf("/"));e=e.replace(/-[0-9]{2,4}x[0-9]{2,4}/,"");a.link=d.substring(0,d.lastIndexOf("/"))+e;if(b.indexOf("alignleft")!=-1){a.I("alignleft").checked="checked";h.className=a.align="alignleft"}else if(b.indexOf("aligncenter")!=-1){a.I("aligncenter").checked="checked";h.className=a.align="aligncenter"}else if(b.indexOf("alignright")!=-1){a.I("alignright").checked="checked";h.className=a.align="alignright"}else if(b.indexOf("alignnone")!=-1){a.I("alignnone").checked="checked";h.className=a.align="alignnone"}a.width&&a.preloadImg.width&&a.showSizeSet();document.body.style.display=""},remove:function(){var a=tinyMCEPopup.editor,b,c;tinyMCEPopup.restoreSelection();c=a.selection.getNode();if(c.nodeName!="IMG")return;(b=a.dom.getParent(c,"div"))&&a.dom.hasClass(b,"mceTemp")?a.dom.remove(b):(b=a.dom.getParent(c,"A"))&&b.childNodes.length==1?a.dom.remove(b):a.dom.remove(c);a.execCommand("mceRepaint");tinyMCEPopup.close();return},update:function(){var a=this,b=document.forms[0],c=tinyMCEPopup.editor,d,e,f=null,g,h,i,j,k=null,l=b.img_classes.value,m,n,o="",p,q,r,s,t,u="",v,w,x;tinyMCEPopup.restoreSelection();d=c.selection.getNode();if(d.nodeName!="IMG")return;if(b.img_src.value===""){a.remove();return}if(b.img_cap_text.value!=""&&b.width.value!=""){k=1;l=l.replace(/align[^ "']+\s?/gi,"")}i=c.dom.getParent(d,"a");h=c.dom.getParent(d,"p");g=c.dom.getParent(d,"dl");j=c.dom.getParent(d,"div");tinyMCEPopup.execCommand("mceBeginUndoLevel");if(b.width.value!=d.width||b.height.value!=d.height)l=l.replace(/size-[^ "']+/,"");c.dom.setAttribs(d,{src:b.img_src.value,title:b.img_title.value,alt:b.img_alt.value,width:b.width.value,height:b.height.value,style:b.img_style.value,"class":l});if(b.link_href.value)if(i==null){b.link_href.value.match(/https?:\/\//i)||(b.link_href.value=tinyMCEPopup.editor.documentBaseURI.toAbsolute(b.link_href.value));c.getDoc().execCommand("unlink",!1,null);tinyMCEPopup.execCommand("mceInsertLink",!1,"#mce_temp_url#",{skip_undo:1});tinymce.each(c.dom.select("a"),function(a){c.dom.getAttrib(a,"href")=="#mce_temp_url#"&&c.dom.setAttribs(a,{href:b.link_href.value,title:b.link_title.value,rel:b.link_rel.value,target:b.link_target.checked==1?"_blank":"","class":b.link_classes.value,style:b.link_style.value})})}else c.dom.setAttribs(i,{href:b.link_href.value,title:b.link_title.value,rel:b.link_rel.value,target:b.link_target.checked==1?"_blank":"","class":b.link_classes.value,style:b.link_style.value});if(k){s=10+parseInt(b.width.value);t=a.align=="aligncenter"?"mceTemp mceIEcenter":"mceTemp";x=b.img_cap_text.value;x=x.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(a){return a.replace(/[\r\n\t]+/," ")});x=x.replace(/\s*\n\s*/g,"<br />");if(g){c.dom.setAttribs(g,{"class":"wp-caption "+a.align,style:"width: "+s+"px;"});j&&c.dom.setAttrib(j,"class",t);(q=c.dom.getParent(d,"dt"))&&(r=q.nextSibling)&&c.dom.hasClass(r,"wp-caption-dd")&&c.dom.setHTML(r,x)}else{(n=b.img_classes.value.match(/wp-image-([0-9]{1,6})/))&&n[1]&&(o="attachment_"+n[1]);if(b.link_href.value&&(u=c.dom.getParent(d,"a")))if(u.childNodes.length==1)m=c.dom.getOuterHTML(u);else{m=c.dom.getOuterHTML(u);m=m.match(/<a [^>]+>/i);m=m+c.dom.getOuterHTML(d)+"</a>"}else m=c.dom.getOuterHTML(d);m='<dl id="'+o+'" class="wp-caption '+a.align+'" style="width: '+s+'px"><dt class="wp-caption-dt">'+m+'</dt><dd class="wp-caption-dd">'+x+"</dd></dl>";p=c.dom.create("div",{"class":t},m);if(h){h.parentNode.insertBefore(p,h);h.childNodes.length==1?c.dom.remove(h):u&&u.childNodes.length==1?c.dom.remove(u):c.dom.remove(d)}else if(v=c.dom.getParent(d,"TD,TH,LI")){v.appendChild(p);u&&u.childNodes.length==1?c.dom.remove(u):c.dom.remove(d)}}}else if(g&&j){b.link_href.value&&(w=c.dom.getParent(d,"a"))?m=c.dom.getOuterHTML(w):m=c.dom.getOuterHTML(d);h=c.dom.create("p",{},m);j.parentNode.insertBefore(h,j);c.dom.remove(j)}b.img_classes.value.indexOf("aligncenter")!=-1?h&&(!h.style||h.style.textAlign!="center")&&c.dom.setStyle(h,"textAlign","center"):h&&h.style&&h.style.textAlign=="center"&&c.dom.setStyle(h,"textAlign","");if(!b.link_href.value&&i){e=c.selection.getBookmark();c.dom.remove(i,1);c.selection.moveToBookmark(e)}tinyMCEPopup.execCommand("mceEndUndoLevel");c.execCommand("mceRepaint");tinyMCEPopup.close()},updateStyle:function(a){var b=tinyMCEPopup.dom,c,d=document.forms[0],e=b.create("img",{style:d.img_style.value});if(tinyMCEPopup.editor.settings.inline_styles){if(a=="align"){b.setStyle(e,"float","");b.setStyle(e,"vertical-align","");c=d.align.value;c&&(c=="left"||c=="right"?b.setStyle(e,"float",c):e.style.verticalAlign=c)}if(a=="border"){b.setStyle(e,"border","");c=d.border.value;if(c||c=="0")c=="0"?e.style.border="0":e.style.border=c+"px solid black"}if(a=="hspace"){b.setStyle(e,"marginLeft","");b.setStyle(e,"marginRight","");c=d.hspace.value;if(c){e.style.marginLeft=c+"px";e.style.marginRight=c+"px"}}if(a=="vspace"){b.setStyle(e,"marginTop","");b.setStyle(e,"marginBottom","");c=d.vspace.value;if(c){e.style.marginTop=c+"px";e.style.marginBottom=c+"px"}}d.img_style.value=b.serializeStyle(b.parseStyle(e.style.cssText));this.demoSetStyle()}},checkVal:function(a){a.value==""&&a.id=="img_src"&&(a.value=this.I("img_demo").src||this.preloadImg.src)},resetImageData:function(){var a=document.forms[0];a.width.value=a.height.value=""},updateImageData:function(){var a=document.forms[0],b=wpImage,c=a.width.value,d=a.height.value;!c&&d?c=a.width.value=b.width=Math.round(b.preloadImg.width/(b.preloadImg.height/d)):c&&!d&&(d=a.height.value=b.height=Math.round(b.preloadImg.height/(b.preloadImg.width/c)));c||(a.width.value=b.width=b.preloadImg.width);d||(a.height.value=b.height=b.preloadImg.height);b.showSizeSet();b.demoSetSize();a.img_style.value&&b.demoSetStyle()},getImageData:function(){var a=wpImage,b=document.forms[0];a.preloadImg=new Image;a.preloadImg.onload=a.updateImageData;a.preloadImg.onerror=a.resetImageData;a.preloadImg.src=tinyMCEPopup.editor.documentBaseURI.toAbsolute(b.img_src.value)}};window.onload=function(){wpImage.init()};wpImage.preInit();