/*
	Speed Plug-in
	
	Features:
		*Adds several properties to the 'file' object indicated upload speed, time left, upload time, etc.
			- currentSpeed -- String indicating the upload speed, bytes per second
			- averageSpeed -- Overall average upload speed, bytes per second
			- movingAverageSpeed -- Speed over averaged over the last several measurements, bytes per second
			- timeRemaining -- Estimated remaining upload time in seconds
			- timeElapsed -- Number of seconds passed for this upload
			- percentUploaded -- Percentage of the file uploaded (0 to 100)
			- sizeUploaded -- Formatted size uploaded so far, bytes
		
		*Adds setting 'moving_average_history_size' for defining the window size used to calculate the moving average speed.
		
		*Adds several Formatting functions for formatting that values provided on the file object.
			- SWFUpload.speed.formatBPS(bps) -- outputs string formatted in the best units (Gbps, Mbps, Kbps, bps)
			- SWFUpload.speed.formatTime(seconds) -- outputs string formatted in the best units (x Hr y M z S)
			- SWFUpload.speed.formatSize(bytes) -- outputs string formatted in the best units (w GB x MB y KB z B )
			- SWFUpload.speed.formatPercent(percent) -- outputs string formatted with a percent sign (x.xx %)
			- SWFUpload.speed.formatUnits(baseNumber, divisionArray, unitLabelArray, fractionalBoolean)
				- Formats a number using the division array to determine how to apply the labels in the Label Array
				- factionalBoolean indicates whether the number should be returned as a single fractional number with a unit (speed)
				    or as several numbers labeled with units (time)
	*/var SWFUpload;if(typeof SWFUpload=="function"){SWFUpload.speed={};SWFUpload.prototype.initSettings=function(a){return function(){typeof a=="function"&&a.call(this);this.ensureDefault=function(a,b){this.settings[a]=this.settings[a]==undefined?b:this.settings[a]};this.fileSpeedStats={};this.speedSettings={};this.ensureDefault("moving_average_history_size","10");this.speedSettings.user_file_queued_handler=this.settings.file_queued_handler;this.speedSettings.user_file_queue_error_handler=this.settings.file_queue_error_handler;this.speedSettings.user_upload_start_handler=this.settings.upload_start_handler;this.speedSettings.user_upload_error_handler=this.settings.upload_error_handler;this.speedSettings.user_upload_progress_handler=this.settings.upload_progress_handler;this.speedSettings.user_upload_success_handler=this.settings.upload_success_handler;this.speedSettings.user_upload_complete_handler=this.settings.upload_complete_handler;this.settings.file_queued_handler=SWFUpload.speed.fileQueuedHandler;this.settings.file_queue_error_handler=SWFUpload.speed.fileQueueErrorHandler;this.settings.upload_start_handler=SWFUpload.speed.uploadStartHandler;this.settings.upload_error_handler=SWFUpload.speed.uploadErrorHandler;this.settings.upload_progress_handler=SWFUpload.speed.uploadProgressHandler;this.settings.upload_success_handler=SWFUpload.speed.uploadSuccessHandler;this.settings.upload_complete_handler=SWFUpload.speed.uploadCompleteHandler;delete this.ensureDefault}}(SWFUpload.prototype.initSettings);SWFUpload.speed.fileQueuedHandler=function(a){if(typeof this.speedSettings.user_file_queued_handler=="function"){a=SWFUpload.speed.extendFile(a);return this.speedSettings.user_file_queued_handler.call(this,a)}};SWFUpload.speed.fileQueueErrorHandler=function(a,b,c){if(typeof this.speedSettings.user_file_queue_error_handler=="function"){a=SWFUpload.speed.extendFile(a);return this.speedSettings.user_file_queue_error_handler.call(this,a,b,c)}};SWFUpload.speed.uploadStartHandler=function(a){if(typeof this.speedSettings.user_upload_start_handler=="function"){a=SWFUpload.speed.extendFile(a,this.fileSpeedStats);return this.speedSettings.user_upload_start_handler.call(this,a)}};SWFUpload.speed.uploadErrorHandler=function(a,b,c){a=SWFUpload.speed.extendFile(a,this.fileSpeedStats);SWFUpload.speed.removeTracking(a,this.fileSpeedStats);if(typeof this.speedSettings.user_upload_error_handler=="function")return this.speedSettings.user_upload_error_handler.call(this,a,b,c)};SWFUpload.speed.uploadProgressHandler=function(a,b,c){this.updateTracking(a,b);a=SWFUpload.speed.extendFile(a,this.fileSpeedStats);if(typeof this.speedSettings.user_upload_progress_handler=="function")return this.speedSettings.user_upload_progress_handler.call(this,a,b,c)};SWFUpload.speed.uploadSuccessHandler=function(a,b){if(typeof this.speedSettings.user_upload_success_handler=="function"){a=SWFUpload.speed.extendFile(a,this.fileSpeedStats);return this.speedSettings.user_upload_success_handler.call(this,a,b)}};SWFUpload.speed.uploadCompleteHandler=function(a){a=SWFUpload.speed.extendFile(a,this.fileSpeedStats);SWFUpload.speed.removeTracking(a,this.fileSpeedStats);if(typeof this.speedSettings.user_upload_complete_handler=="function")return this.speedSettings.user_upload_complete_handler.call(this,a)};SWFUpload.speed.extendFile=function(a,b){var c;b&&(c=b[a.id]);if(c){a.currentSpeed=c.currentSpeed;a.averageSpeed=c.averageSpeed;a.movingAverageSpeed=c.movingAverageSpeed;a.timeRemaining=c.timeRemaining;a.timeElapsed=c.timeElapsed;a.percentUploaded=c.percentUploaded;a.sizeUploaded=c.bytesUploaded}else{a.currentSpeed=0;a.averageSpeed=0;a.movingAverageSpeed=0;a.timeRemaining=0;a.timeElapsed=0;a.percentUploaded=0;a.sizeUploaded=0}return a};SWFUpload.prototype.updateTracking=function(a,b){var c=this.fileSpeedStats[a.id];c||(this.fileSpeedStats[a.id]=c={});b=b||c.bytesUploaded||0;b<0&&(b=0);b>a.size&&(b=a.size);var d=(new Date).getTime();if(!c.startTime){c.startTime=(new Date).getTime();c.lastTime=c.startTime;c.currentSpeed=0;c.averageSpeed=0;c.movingAverageSpeed=0;c.movingAverageHistory=[];c.timeRemaining=0;c.timeElapsed=0;c.percentUploaded=b/a.size;c.bytesUploaded=b}else if(c.startTime>d)this.debug("When backwards in time");else{var e=(new Date).getTime(),f=c.lastTime,g=e-f,h=b-c.bytesUploaded;if(h===0||g===0)return c;c.lastTime=e;c.bytesUploaded=b;c.currentSpeed=h*8/(g/1e3);c.averageSpeed=c.bytesUploaded*8/((e-c.startTime)/1e3);c.movingAverageHistory.push(c.currentSpeed);c.movingAverageHistory.length>this.settings.moving_average_history_size&&c.movingAverageHistory.shift();c.movingAverageSpeed=SWFUpload.speed.calculateMovingAverage(c.movingAverageHistory);c.timeRemaining=(a.size-c.bytesUploaded)*8/c.movingAverageSpeed;c.timeElapsed=(e-c.startTime)/1e3;c.percentUploaded=c.bytesUploaded/a.size*100}return c};SWFUpload.speed.removeTracking=function(a,b){try{b[a.id]=null;delete b[a.id]}catch(c){}};SWFUpload.speed.formatUnits=function(a,b,c,d){var e,f,g,h;if(a===0)return"0 "+c[c.length-1];if(d){f=a;h=c.length>=b.length?c[b.length-1]:"";for(e=0;e<b.length;e++)if(a>=b[e]){f=(a/b[e]).toFixed(2);h=c.length>=e?" "+c[e]:"";break}return f+h}var i=[],j=a;for(e=0;e<b.length;e++){g=b[e];h=c.length>e?" "+c[e]:"";f=j/g;e<b.length-1?f=Math.floor(f):f=f.toFixed(2);if(f>0){j%=g;i.push(f+h)}}return i.join(" ")};SWFUpload.speed.formatBPS=function(a){var b=[1073741824,1048576,1024,1],c=["Gbps","Mbps","Kbps","bps"];return SWFUpload.speed.formatUnits(a,b,c,!0)};SWFUpload.speed.formatTime=function(a){var b=[86400,3600,60,1],c=["d","h","m","s"];return SWFUpload.speed.formatUnits(a,b,c,!1)};SWFUpload.speed.formatBytes=function(a){var b=[1073741824,1048576,1024,1],c=["GB","MB","KB","bytes"];return SWFUpload.speed.formatUnits(a,b,c,!0)};SWFUpload.speed.formatPercent=function(a){return a.toFixed(2)+" %"};SWFUpload.speed.calculateMovingAverage=function(a){var b=[],c,d=0,e=0,f=0,g=0,h=0,i,j=0,k=0;c=a.length;if(c>=8){for(i=0;i<c;i++){b[i]=a[i];d+=b[i]}e=d/c;for(i=0;i<c;i++)f+=Math.pow(b[i]-e,2);g=f/c;h=Math.sqrt(g);for(i=0;i<c;i++)b[i]=(b[i]-e)/h;var l=2;for(i=0;i<c;i++)if(b[i]<=l&&b[i]>=-l){k++;j+=a[i]}}else{k=c;for(i=0;i<c;i++)j+=a[i]}return j/k}};