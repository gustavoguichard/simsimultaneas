(function(e){function s(){return e("<div/>")}var t=Math.abs,n=Math.max,r=Math.min,i=Math.round;e.imgAreaSelect=function(o,u){function et(e){return e+x.left-k.left}function tt(e){return e+x.top-k.top}function nt(e){return e-x.left+k.left}function rt(e){return e-x.top+k.top}function it(e){return e.pageX-k.left}function st(e){return e.pageY-k.top}function ot(e){var t=e||_,n=e||D;return{x1:i(X.x1*t),y1:i(X.y1*n),x2:i(X.x2*t),y2:i(X.y2*n),width:i(X.x2*t)-i(X.x1*t),height:i(X.y2*n)-i(X.y1*n)}}function ut(e,t,n,r,s){var o=s||_,u=s||D;X={x1:i(e/o||0),y1:i(t/u||0),x2:i(n/o||0),y2:i(r/u||0)};X.width=X.x2-X.x1;X.height=X.y2-X.y1}function at(){if(!l.width())return;x={left:i(l.offset().left),top:i(l.offset().top)};T=l.innerWidth();N=l.innerHeight();x.top+=l.outerHeight()-N>>1;x.left+=l.outerWidth()-T>>1;H=i(u.minWidth/_)||0;B=i(u.minHeight/D)||0;j=i(r(u.maxWidth/_||1<<24,T));F=i(r(u.maxHeight/D||1<<24,N));if(e().jquery=="1.3.2"&&A=="fixed"&&!V.getBoundingClientRect){x.top+=n(document.body.scrollTop,V.scrollTop);x.left+=n(document.body.scrollLeft,V.scrollLeft)}k=/absolute|relative/.test(C.css("position"))?{left:i(C.offset().left)-C.scrollLeft(),top:i(C.offset().top)-C.scrollTop()}:A=="fixed"?{left:e(document).scrollLeft(),top:e(document).scrollTop()}:{left:0,top:0};E=et(0);S=tt(0);(X.x2>T||X.y2>N)&&mt()}function ft(t){if(!q)return;p.css({left:et(X.x1),top:tt(X.y1)}).add(v).width(G=X.width).height(Y=X.height);v.add(m).add(y).css({left:0,top:0});m.width(n(G-m.outerWidth()+m.innerWidth(),0)).height(n(Y-m.outerHeight()+m.innerHeight(),0));e(g[0]).css({left:E,top:S,width:X.x1,height:N});e(g[1]).css({left:E+X.x1,top:S,width:G,height:X.y1});e(g[2]).css({left:E+X.x2,top:S,width:T-X.x2,height:N});e(g[3]).css({left:E+X.x1,top:S+X.y2,width:G,height:N-X.y2});G-=y.outerWidth();Y-=y.outerHeight();switch(y.length){case 8:e(y[4]).css({left:G>>1});e(y[5]).css({left:G,top:Y>>1});e(y[6]).css({left:G>>1,top:Y});e(y[7]).css({top:Y>>1});case 4:y.slice(1,3).css({left:G});y.slice(2,4).css({top:Y})}if(t!==!1){e.imgAreaSelect.keyPress!=Nt&&e(document).unbind(e.imgAreaSelect.keyPress,e.imgAreaSelect.onKeyPress);u.keys&&e(document)[e.imgAreaSelect.keyPress](e.imgAreaSelect.onKeyPress=Nt)}if(e.browser.msie&&m.outerWidth()-m.innerWidth()==2){m.css("margin",0);setTimeout(function(){m.css("margin","auto")},0)}}function lt(e){at();ft(e);R=et(X.x1);U=tt(X.y1);z=et(X.x2);W=tt(X.y2)}function ct(e,t){u.fadeSpeed?e.fadeOut(u.fadeSpeed,t):e.hide()}function ht(e){var t=nt(it(e))-X.x1,n=rt(st(e))-X.y1;if(!Z){at();Z=!0;p.one("mouseout",function(){Z=!1})}P="";if(u.resizable){n<=u.resizeMargin?P="n":n>=X.height-u.resizeMargin&&(P="s");t<=u.resizeMargin?P+="w":t>=X.width-u.resizeMargin&&(P+="e")}p.css("cursor",P?P+"-resize":u.movable?"move":"");w&&w.toggle()}function pt(t){e("body").css("cursor","");(u.autoHide||X.width*X.height==0)&&ct(p.add(g),function(){e(this).hide()});e(document).unbind("mousemove",gt);p.mousemove(ht);u.onSelectEnd(o,ot())}function dt(t){if(t.which!=1)return!1;at();if(P){e("body").css("cursor",P+"-resize");R=et(X[/w/.test(P)?"x2":"x1"]);U=tt(X[/n/.test(P)?"y2":"y1"]);e(document).mousemove(gt).one("mouseup",pt);p.unbind("mousemove",ht)}else if(u.movable){O=E+X.x1-it(t);M=S+X.y1-st(t);p.unbind("mousemove",ht);e(document).mousemove(bt).one("mouseup",function(){u.onSelectEnd(o,ot());e(document).unbind("mousemove",bt);p.mousemove(ht)})}else l.mousedown(t);return!1}function vt(e){if(I)if(e){z=n(E,r(E+T,R+t(W-U)*I*(z>R||-1)));W=i(n(S,r(S+N,U+t(z-R)/I*(W>U||-1))));z=i(z)}else{W=n(S,r(S+N,U+t(z-R)/I*(W>U||-1)));z=i(n(E,r(E+T,R+t(W-U)*I*(z>R||-1))));W=i(W)}}function mt(){R=r(R,E+T);U=r(U,S+N);if(t(z-R)<H){z=R-H*(z<R||-1);z<E?R=E+H:z>E+T&&(R=E+T-H)}if(t(W-U)<B){W=U-B*(W<U||-1);W<S?U=S+B:W>S+N&&(U=S+N-B)}z=n(E,r(z,E+T));W=n(S,r(W,S+N));vt(t(z-R)<t(W-U)*I);if(t(z-R)>j){z=R-j*(z<R||-1);vt()}if(t(W-U)>F){W=U-F*(W<U||-1);vt(!0)}X={x1:nt(r(R,z)),x2:nt(n(R,z)),y1:rt(r(U,W)),y2:rt(n(U,W)),width:t(z-R),height:t(W-U)};ft();u.onSelectChange(o,ot())}function gt(e){z=/w|e|^$/.test(P)||I?it(e):et(X.x2);W=/n|s|^$/.test(P)||I?st(e):tt(X.y2);mt();return!1}function yt(t,n){z=(R=t)+X.width;W=(U=n)+X.height;e.extend(X,{x1:nt(R),y1:rt(U),x2:nt(z),y2:rt(W)});ft();u.onSelectChange(o,ot())}function bt(e){R=n(E,r(O+it(e),E+T-X.width));U=n(S,r(M+st(e),S+N-X.height));yt(R,U);e.preventDefault();return!1}function wt(){e(document).unbind("mousemove",wt);at();z=R;W=U;mt();P="";g.is(":visible")||p.add(g).hide().fadeIn(u.fadeSpeed||0);q=!0;e(document).unbind("mouseup",Et).mousemove(gt).one("mouseup",pt);p.unbind("mousemove",ht);u.onSelectStart(o,ot())}function Et(){e(document).unbind("mousemove",wt).unbind("mouseup",Et);ct(p.add(g));ut(nt(R),rt(U),nt(R),rt(U));if(!(this instanceof e.imgAreaSelect)){u.onSelectChange(o,ot());u.onSelectEnd(o,ot())}}function St(t){if(t.which!=1||g.is(":animated"))return!1;at();O=R=it(t);M=U=st(t);e(document).mousemove(wt).mouseup(Et);return!1}function xt(){lt(!1)}function Tt(){h=!0;kt(u=e.extend({classPrefix:"imgareaselect",movable:!0,parent:"body",resizable:!0,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},u));p.add(g).css({visibility:""});if(u.show){q=!0;at();ft();p.add(g).hide().fadeIn(u.fadeSpeed||0)}setTimeout(function(){u.onInit(o,ot())},0)}function Ct(e,t){for(var n in t)u[n]!==undefined&&e.css(t[n],u[n])}function kt(t){t.parent&&(C=e(t.parent)).append(p.add(g));e.extend(u,t);at();if(t.handles!=null){y.remove();y=e([]);K=t.handles?t.handles=="corners"?4:8:0;while(K--)y=y.add(s());y.addClass(u.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:L+1||1});!parseInt(y.css("width"))>=0&&y.width(5).height(5);(Q=u.borderWidth)&&y.css({borderWidth:Q,borderStyle:"solid"});Ct(y,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}_=u.imageWidth/T||1;D=u.imageHeight/N||1;if(t.x1!=null){ut(t.x1,t.y1,t.x2,t.y2);t.show=!t.hide}t.keys&&(u.keys=e.extend({shift:1,ctrl:"resize"},t.keys));g.addClass(u.classPrefix+"-outer");v.addClass(u.classPrefix+"-selection");for(K=0;K++<4;)e(m[K-1]).addClass(u.classPrefix+"-border"+K);Ct(v,{selectionColor:"background-color",selectionOpacity:"opacity"});Ct(m,{borderOpacity:"opacity",borderWidth:"border-width"});Ct(g,{outerColor:"background-color",outerOpacity:"opacity"});(Q=u.borderColor1)&&e(m[0]).css({borderStyle:"solid",borderColor:Q});(Q=u.borderColor2)&&e(m[1]).css({borderStyle:"dashed",borderColor:Q});p.append(v.add(m).add(w).add(y));if(e.browser.msie){(Q=g.css("filter").match(/opacity=(\d+)/))&&g.css("opacity",Q[1]/100);(Q=m.css("filter").match(/opacity=(\d+)/))&&m.css("opacity",Q[1]/100)}if(t.hide)ct(p.add(g));else if(t.show&&h){q=!0;p.add(g).fadeIn(u.fadeSpeed||0);lt()}I=(J=(u.aspectRatio||"").split(/:/))[0]/J[1];l.add(g).unbind("mousedown",St);if(u.disable||u.enable===!1){p.unbind("mousemove",ht).unbind("mousedown",dt);e(window).unbind("resize",xt)}else{if(u.enable||u.disable===!1){(u.resizable||u.movable)&&p.mousemove(ht).mousedown(dt);e(window).resize(xt)}u.persistent||l.add(g).mousedown(St)}u.enable=u.disable=undefined}var l=e(o),h,p=s(),v=s(),m=s().add(s()).add(s()).add(s()),g=s().add(s()).add(s()).add(s()),y=e([]),w,E,S,x={left:0,top:0},T,N,C,k={left:0,top:0},L=0,A="absolute",O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X={x1:0,y1:0,x2:0,y2:0,width:0,height:0},V=document.documentElement,$,J,K,Q,G,Y,Z,Nt=function(e){var t=u.keys,i,s,o=e.keyCode;i=!isNaN(t.alt)&&(e.altKey||e.originalEvent.altKey)?t.alt:!isNaN(t.ctrl)&&e.ctrlKey?t.ctrl:!isNaN(t.shift)&&e.shiftKey?t.shift:isNaN(t.arrows)?10:t.arrows;if(t.arrows=="resize"||t.shift=="resize"&&e.shiftKey||t.ctrl=="resize"&&e.ctrlKey||t.alt=="resize"&&(e.altKey||e.originalEvent.altKey)){switch(o){case 37:i=-i;case 39:s=n(R,z);R=r(R,z);z=n(s+i,R);vt();break;case 38:i=-i;case 40:s=n(U,W);U=r(U,W);W=n(s+i,U);vt(!0);break;default:return}mt()}else{R=r(R,z);U=r(U,W);switch(o){case 37:yt(n(R-i,E),U);break;case 38:yt(R,n(U-i,S));break;case 39:yt(R+r(i,T-nt(z)),U);break;case 40:yt(R,U+r(i,N-rt(W)));break;default:return}}return!1};this.remove=function(){kt({disable:!0});p.add(g).remove()};this.getOptions=function(){return u};this.setOptions=kt;this.getSelection=ot;this.setSelection=ut;this.cancelSelection=Et;this.update=lt;$=l;while($.length){L=n(L,isNaN($.css("z-index"))?L:$.css("z-index"));$.css("position")=="fixed"&&(A="fixed");$=$.parent(":not(body)")}L=u.zIndex||L;e.browser.msie&&l.attr("unselectable","on");e.imgAreaSelect.keyPress=e.browser.msie||e.browser.safari?"keydown":"keypress";e.browser.opera&&(w=s().css({width:"100%",height:"100%",position:"absolute",zIndex:L+2||2}));p.add(g).css({visibility:"hidden",position:A,overflow:"hidden",zIndex:L||"0"});p.css({zIndex:L+2||2});v.add(m).css({position:"absolute",fontSize:0});o.complete||o.readyState=="complete"||!l.is("img")?Tt():l.one("load",Tt);!h&&e.browser.msie&&e.browser.version>=7&&(o.src=o.src)};e.fn.imgAreaSelect=function(t){t=t||{};this.each(function(){if(e(this).data("imgAreaSelect"))if(t.remove){e(this).data("imgAreaSelect").remove();e(this).removeData("imgAreaSelect")}else e(this).data("imgAreaSelect").setOptions(t);else if(!t.remove){t.enable===undefined&&t.disable===undefined&&(t.enable=!0);e(this).data("imgAreaSelect",new e.imgAreaSelect(this,t))}});return t.instance?e(this).data("imgAreaSelect"):this}})(jQuery);