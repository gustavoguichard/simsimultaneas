/*
 * imgAreaSelect jQuery plugin
 * version 0.9.8
 *
 * Copyright (c) 2008-2011 Michal Wojciechowski (odyniec.net)
 *
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * http://odyniec.net/projects/imgareaselect/
 *
 */(function(a){function f(){return a("<div/>")}var b=Math.abs,c=Math.max,d=Math.min,e=Math.round;a.imgAreaSelect=function(g,h){function X(a){return a+s.left-w.left}function Y(a){return a+s.top-w.top}function Z(a){return a-s.left+w.left}function _(a){return a-s.top+w.top}function ab(a){return a.pageX-w.left}function bb(a){return a.pageY-w.top}function cb(a){var b=a||B,c=a||C;return{x1:e(O.x1*b),y1:e(O.y1*c),x2:e(O.x2*b),y2:e(O.y2*c),width:e(O.x2*b)-e(O.x1*b),height:e(O.y2*c)-e(O.y1*c)}}function db(a,b,c,d,f){var g=f||B,h=f||C;O={x1:e(a/g||0),y1:e(b/h||0),x2:e(c/g||0),y2:e(d/h||0)};O.width=O.x2-O.x1;O.height=O.y2-O.y1}function eb(){if(!i.width())return;s={left:e(i.offset().left),top:e(i.offset().top)};t=i.innerWidth();u=i.innerHeight();s.top+=i.outerHeight()-u>>1;s.left+=i.outerWidth()-t>>1;E=e(h.minWidth/B)||0;F=e(h.minHeight/C)||0;G=e(d(h.maxWidth/B||1<<24,t));H=e(d(h.maxHeight/C||1<<24,u));if(a().jquery=="1.3.2"&&y=="fixed"&&!P.getBoundingClientRect){s.top+=c(document.body.scrollTop,P.scrollTop);s.left+=c(document.body.scrollLeft,P.scrollLeft)}w=/absolute|relative/.test(v.css("position"))?{left:e(v.offset().left)-v.scrollLeft(),top:e(v.offset().top)-v.scrollTop()}:y=="fixed"?{left:a(document).scrollLeft(),top:a(document).scrollTop()}:{left:0,top:0};q=X(0);r=Y(0);(O.x2>t||O.y2>u)&&mb()}function fb(b){if(!J)return;k.css({left:X(O.x1),top:Y(O.y1)}).add(l).width(U=O.width).height(V=O.height);l.add(m).add(o).css({left:0,top:0});m.width(c(U-m.outerWidth()+m.innerWidth(),0)).height(c(V-m.outerHeight()+m.innerHeight(),0));a(n[0]).css({left:q,top:r,width:O.x1,height:u});a(n[1]).css({left:q+O.x1,top:r,width:U,height:O.y1});a(n[2]).css({left:q+O.x2,top:r,width:t-O.x2,height:u});a(n[3]).css({left:q+O.x1,top:r+O.y2,width:U,height:u-O.y2});U-=o.outerWidth();V-=o.outerHeight();switch(o.length){case 8:a(o[4]).css({left:U>>1});a(o[5]).css({left:U,top:V>>1});a(o[6]).css({left:U>>1,top:V});a(o[7]).css({top:V>>1});case 4:o.slice(1,3).css({left:U});o.slice(2,4).css({top:V})}if(b!==!1){a.imgAreaSelect.keyPress!=vb&&a(document).unbind(a.imgAreaSelect.keyPress,a.imgAreaSelect.onKeyPress);h.keys&&a(document)[a.imgAreaSelect.keyPress](a.imgAreaSelect.onKeyPress=vb)}if(a.browser.msie&&m.outerWidth()-m.innerWidth()==2){m.css("margin",0);setTimeout(function(){m.css("margin","auto")},0)}}function gb(a){eb();fb(a);K=X(O.x1);L=Y(O.y1);M=X(O.x2);N=Y(O.y2)}function hb(a,b){h.fadeSpeed?a.fadeOut(h.fadeSpeed,b):a.hide()}function ib(a){var b=Z(ab(a))-O.x1,c=_(bb(a))-O.y1;if(!W){eb();W=!0;k.one("mouseout",function(){W=!1})}D="";if(h.resizable){c<=h.resizeMargin?D="n":c>=O.height-h.resizeMargin&&(D="s");b<=h.resizeMargin?D+="w":b>=O.width-h.resizeMargin&&(D+="e")}k.css("cursor",D?D+"-resize":h.movable?"move":"");p&&p.toggle()}function jb(b){a("body").css("cursor","");(h.autoHide||O.width*O.height==0)&&hb(k.add(n),function(){a(this).hide()});a(document).unbind("mousemove",nb);k.mousemove(ib);h.onSelectEnd(g,cb())}function kb(b){if(b.which!=1)return!1;eb();if(D){a("body").css("cursor",D+"-resize");K=X(O[/w/.test(D)?"x2":"x1"]);L=Y(O[/n/.test(D)?"y2":"y1"]);a(document).mousemove(nb).one("mouseup",jb);k.unbind("mousemove",ib)}else if(h.movable){z=q+O.x1-ab(b);A=r+O.y1-bb(b);k.unbind("mousemove",ib);a(document).mousemove(pb).one("mouseup",function(){h.onSelectEnd(g,cb());a(document).unbind("mousemove",pb);k.mousemove(ib)})}else i.mousedown(b);return!1}function lb(a){if(I)if(a){M=c(q,d(q+t,K+b(N-L)*I*(M>K||-1)));N=e(c(r,d(r+u,L+b(M-K)/I*(N>L||-1))));M=e(M)}else{N=c(r,d(r+u,L+b(M-K)/I*(N>L||-1)));M=e(c(q,d(q+t,K+b(N-L)*I*(M>K||-1))));N=e(N)}}function mb(){K=d(K,q+t);L=d(L,r+u);if(b(M-K)<E){M=K-E*(M<K||-1);M<q?K=q+E:M>q+t&&(K=q+t-E)}if(b(N-L)<F){N=L-F*(N<L||-1);N<r?L=r+F:N>r+u&&(L=r+u-F)}M=c(q,d(M,q+t));N=c(r,d(N,r+u));lb(b(M-K)<b(N-L)*I);if(b(M-K)>G){M=K-G*(M<K||-1);lb()}if(b(N-L)>H){N=L-H*(N<L||-1);lb(!0)}O={x1:Z(d(K,M)),x2:Z(c(K,M)),y1:_(d(L,N)),y2:_(c(L,N)),width:b(M-K),height:b(N-L)};fb();h.onSelectChange(g,cb())}function nb(a){M=/w|e|^$/.test(D)||I?ab(a):X(O.x2);N=/n|s|^$/.test(D)||I?bb(a):Y(O.y2);mb();return!1}function ob(b,c){M=(K=b)+O.width;N=(L=c)+O.height;a.extend(O,{x1:Z(K),y1:_(L),x2:Z(M),y2:_(N)});fb();h.onSelectChange(g,cb())}function pb(a){K=c(q,d(z+ab(a),q+t-O.width));L=c(r,d(A+bb(a),r+u-O.height));ob(K,L);a.preventDefault();return!1}function qb(){a(document).unbind("mousemove",qb);eb();M=K;N=L;mb();D="";n.is(":visible")||k.add(n).hide().fadeIn(h.fadeSpeed||0);J=!0;a(document).unbind("mouseup",rb).mousemove(nb).one("mouseup",jb);k.unbind("mousemove",ib);h.onSelectStart(g,cb())}function rb(){a(document).unbind("mousemove",qb).unbind("mouseup",rb);hb(k.add(n));db(Z(K),_(L),Z(K),_(L));if(!this instanceof a.imgAreaSelect){h.onSelectChange(g,cb());h.onSelectEnd(g,cb())}}function sb(b){if(b.which!=1||n.is(":animated"))return!1;eb();z=K=ab(b);A=L=bb(b);a(document).mousemove(qb).mouseup(rb);return!1}function tb(){gb(!1)}function ub(){j=!0;xb(h=a.extend({classPrefix:"imgareaselect",movable:!0,parent:"body",resizable:!0,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},h));k.add(n).css({visibility:""});if(h.show){J=!0;eb();fb();k.add(n).hide().fadeIn(h.fadeSpeed||0)}setTimeout(function(){h.onInit(g,cb())},0)}function wb(a,b){for(option in b)h[option]!==undefined&&a.css(b[option],h[option])}function xb(b){b.parent&&(v=a(b.parent)).append(k.add(n));a.extend(h,b);eb();if(b.handles!=null){o.remove();o=a([]);S=b.handles?b.handles=="corners"?4:8:0;while(S--)o=o.add(f());o.addClass(h.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:x+1||1});!parseInt(o.css("width"))>=0&&o.width(5).height(5);(T=h.borderWidth)&&o.css({borderWidth:T,borderStyle:"solid"});wb(o,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}B=h.imageWidth/t||1;C=h.imageHeight/u||1;if(b.x1!=null){db(b.x1,b.y1,b.x2,b.y2);b.show=!b.hide}b.keys&&(h.keys=a.extend({shift:1,ctrl:"resize"},b.keys));n.addClass(h.classPrefix+"-outer");l.addClass(h.classPrefix+"-selection");for(S=0;S++<4;)a(m[S-1]).addClass(h.classPrefix+"-border"+S);wb(l,{selectionColor:"background-color",selectionOpacity:"opacity"});wb(m,{borderOpacity:"opacity",borderWidth:"border-width"});wb(n,{outerColor:"background-color",outerOpacity:"opacity"});(T=h.borderColor1)&&a(m[0]).css({borderStyle:"solid",borderColor:T});(T=h.borderColor2)&&a(m[1]).css({borderStyle:"dashed",borderColor:T});k.append(l.add(m).add(p).add(o));if(a.browser.msie){(T=n.css("filter").match(/opacity=(\d+)/))&&n.css("opacity",T[1]/100);(T=m.css("filter").match(/opacity=(\d+)/))&&m.css("opacity",T[1]/100)}if(b.hide)hb(k.add(n));else if(b.show&&j){J=!0;k.add(n).fadeIn(h.fadeSpeed||0);gb()}I=(R=(h.aspectRatio||"").split(/:/))[0]/R[1];i.add(n).unbind("mousedown",sb);if(h.disable||h.enable===!1){k.unbind("mousemove",ib).unbind("mousedown",kb);a(window).unbind("resize",tb)}else{if(h.enable||h.disable===!1){(h.resizable||h.movable)&&k.mousemove(ib).mousedown(kb);a(window).resize(tb)}h.persistent||i.add(n).mousedown(sb)}h.enable=h.disable=undefined}var i=a(g),j,k=f(),l=f(),m=f().add(f()).add(f()).add(f()),n=f().add(f()).add(f()).add(f()),o=a([]),p,q,r,s={left:0,top:0},t,u,v,w={left:0,top:0},x=0,y="absolute",z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O={x1:0,y1:0,x2:0,y2:0,width:0,height:0},P=document.documentElement,Q,R,S,T,U,V,W,vb=function(a){var b=h.keys,e,f,g=a.keyCode;e=!isNaN(b.alt)&&(a.altKey||a.originalEvent.altKey)?b.alt:!isNaN(b.ctrl)&&a.ctrlKey?b.ctrl:!isNaN(b.shift)&&a.shiftKey?b.shift:isNaN(b.arrows)?10:b.arrows;if(b.arrows=="resize"||b.shift=="resize"&&a.shiftKey||b.ctrl=="resize"&&a.ctrlKey||b.alt=="resize"&&(a.altKey||a.originalEvent.altKey)){switch(g){case 37:e=-e;case 39:f=c(K,M);K=d(K,M);M=c(f+e,K);lb();break;case 38:e=-e;case 40:f=c(L,N);L=d(L,N);N=c(f+e,L);lb(!0);break;default:return}mb()}else{K=d(K,M);L=d(L,N);switch(g){case 37:ob(c(K-e,q),L);break;case 38:ob(K,c(L-e,r));break;case 39:ob(K+d(e,t-Z(M)),L);break;case 40:ob(K,L+d(e,u-_(N)));break;default:return}}return!1};this.remove=function(){xb({disable:!0});k.add(n).remove()};this.getOptions=function(){return h};this.setOptions=xb;this.getSelection=cb;this.setSelection=db;this.cancelSelection=rb;this.update=gb;Q=i;while(Q.length){x=c(x,isNaN(Q.css("z-index"))?x:Q.css("z-index"));Q.css("position")=="fixed"&&(y="fixed");Q=Q.parent(":not(body)")}x=h.zIndex||x;a.browser.msie&&i.attr("unselectable","on");a.imgAreaSelect.keyPress=a.browser.msie||a.browser.safari?"keydown":"keypress";a.browser.opera&&(p=f().css({width:"100%",height:"100%",position:"absolute",zIndex:x+2||2}));k.add(n).css({visibility:"hidden",position:y,overflow:"hidden",zIndex:x||"0"});k.css({zIndex:x+2||2});l.add(m).css({position:"absolute",fontSize:0});g.complete||g.readyState=="complete"||!i.is("img")?ub():i.one("load",ub);a.browser.msie&&a.browser.version>=7&&(g.src=g.src)};a.fn.imgAreaSelect=function(b){b=b||{};this.each(function(){if(a(this).data("imgAreaSelect"))if(b.remove){a(this).data("imgAreaSelect").remove();a(this).removeData("imgAreaSelect")}else a(this).data("imgAreaSelect").setOptions(b);else if(!b.remove){b.enable===undefined&&b.disable===undefined&&(b.enable=!0);a(this).data("imgAreaSelect",new a.imgAreaSelect(this,b))}});return b.instance?a(this).data("imgAreaSelect"):this}})(jQuery);